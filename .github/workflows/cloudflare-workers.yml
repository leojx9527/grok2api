name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci || npm install

      - name: Ensure Resources and Config
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python -m pip install tomli tomli-w
          python -u - <<'PY'
          import json, os, re, urllib.request, tomli_w
          try: import tomllib
          except ImportError: import tomli as tomllib

          token = os.environ.get("CLOUDFLARE_API_TOKEN", "")
          account_id = os.environ.get("CLOUDFLARE_ACCOUNT_ID", "")
          
          def request(method, url, data=None):
              headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
              body = None if data is None else json.dumps(data).encode("utf-8")
              req = urllib.request.Request(url, data=body, headers=headers, method=method)
              with urllib.request.urlopen(req) as resp: return json.loads(resp.read().decode("utf-8"))

          # 获取 KV ID
          kv_res = request("GET", f"https://api.cloudflare.com/client/v4/accounts/{account_id}/storage/kv/namespaces")
          kv_id = next((i['id'] for i in kv_res.get('result', []) if i['title'] == 'grok2api-cache'), None)
          if not kv_id:
              kv_id = request("POST", f"https://api.cloudflare.com/client/v4/accounts/{account_id}/storage/kv/namespaces", {"title": "grok2api-cache"})['result']['id']

          # 获取 D1 ID
          d1_res = request("GET", f"https://api.cloudflare.com/client/v4/accounts/{account_id}/d1/database")
          d1_id = next((i.get('uuid') or i.get('id') for i in d1_res.get('result', []) if i['name'] == 'grok2api'), None)
          if not d1_id:
              d1_id = request("POST", f"https://api.cloudflare.com/client/v4/accounts/{account_id}/d1/database", {"name": "grok2api"})['result']['uuid']

          # 读取并生成新配置
          with open("wrangler.toml", "rb") as f: config = tomllib.load(f)
          config["d1_databases"] = [{"binding": "DB", "database_name": "grok2api", "database_id": d1_id}]
          config["kv_namespaces"] = [{"binding": "cache", "id": kv_id}]
          if "vars" not in config: config["vars"] = {}
          config["vars"]["BUILD_SHA"] = os.environ.get("GITHUB_SHA", "latest")

          with open("wrangler.ci.toml", "wb") as f: tomli_w.dump(config, f)
          PY

      - name: Apply D1 migrations
        run: npx wrangler d1 migrations apply DB --remote --config wrangler.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker
        run: npx wrangler deploy --config wrangler.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
