name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Deployment target"
        type: choice
        required: true
        default: cloudflare
        options:
          - cloudflare
          - docker
          - both
  push:
    branches:
      - main
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  deploy-cloudflare:
    if: ${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'cloudflare' || github.event.inputs.deploy_target == 'both')) || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Ensure D1 + KV and generate wrangler.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python -u - <<'PY'
          import json
          import os
          import re
          import urllib.request
          
          token = os.environ.get("CLOUDFLARE_API_TOKEN", "")
          account_id = os.environ.get("CLOUDFLARE_ACCOUNT_ID", "")
          build_sha = os.environ.get("GITHUB_SHA", "") or ""
          if not token or not account_id:
              raise SystemExit("Missing CLOUDFLARE_API_TOKEN or CLOUDFLARE_ACCOUNT_ID")

          src_path = "wrangler.toml"
          dst_path = "wrangler.ci.toml"
          wrangler_text = open(src_path, "r", encoding="utf-8").read()

          def extract(pattern: str, fallback: str) -> str:
              m = re.search(pattern, wrangler_text)
              return m.group(1).strip() if m and m.group(1).strip() else fallback

          worker_name = extract(r'(?m)^name\s*=\s*"([^"]+)"\s*$', "grok2api")
          kv_title = f"{worker_name}-cache"
          kv_base = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/storage/kv/namespaces"
          
          def request(method: str, url: str, data=None):
              headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
              body = None if data is None else json.dumps(data).encode("utf-8")
              req = urllib.request.Request(url, data=body, headers=headers, method=method)
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode("utf-8"))
          
          kv_id = None
          res = request("GET", f"{kv_base}?per_page=100")
          for item in res.get("result", []):
              if item.get("title") == kv_title:
                  kv_id = item.get("id")
          if not kv_id:
              res = request("POST", kv_base, {"title": kv_title})
              kv_id = res["result"]["id"]

          d1_name = extract(r'(?m)^database_name\s*=\s*"([^"]+)"\s*$', worker_name)
          d1_base = f"https://api.cloudflare.com/client/v4/accounts/{account_id}/d1/database"
          d1_id = None
          res = request("GET", f"{d1_base}?per_page=100")
          for item in res.get("result", []):
              if item.get("name") == d1_name:
                  d1_id = item.get("uuid") or item.get("id")
          if not d1_id:
              res = request("POST", d1_base, {"name": d1_name})
              d1_id = res["result"]["uuid"]

          text2 = wrangler_text
          text2 = re.sub(r'REPLACE_WITH_KV_NAMESPACE_ID', kv_id, text2)
          text2 = re.sub(r'REPLACE_WITH_D1_DATABASE_ID', d1_id, text2)
          
          # 注入 BUILD_SHA
          if build_sha:
              if "[vars]" in text2:
                  text2 = text2.replace("[vars]", f'[vars]\nBUILD_SHA = "{build_sha}"')
              else:
                  text2 += f'\n[vars]\nBUILD_SHA = "{build_sha}"'
          
          open(dst_path, "w", encoding="utf-8").write(text2)
          PY

      - name: Verify US placement
        run: |
          # 修正：同时安装 tomli 和 tomli-w
          python -m pip install tomli tomli-w
          python -u - <<'PY'
          import os
          import tomli_w
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib

          # 读取并校验
          with open('wrangler.ci.toml', 'rb') as f:
              config = tomllib.load(f)

          placement = config.get("placement", {})
          if placement.get("region") != "aws:us-east-1":
              print("Warning: region is not aws:us-east-1, but proceeding...")

          # 写回 (确保格式正确)
          with open('wrangler.ci.toml', 'wb') as f:
              tomli_w.dump(config, f)
          PY

      - name: Apply D1 migrations
        run: npx wrangler d1 migrations apply DB --remote --config wrangler.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker
        run: npx wrangler deploy --config wrangler.ci.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
