- name: Verify US placement
        run: |
          # 安装读取库 tomli 和 写入库 tomli-w
          python -m pip install tomli tomli-w
          python -u - <<'PY'
          import os
          import tomli_w  # 专门用于写入的库
          
          # 兼容性处理：优先使用内置的 tomllib (Python 3.11+)
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib

          # 1. 读取文件 (必须使用 'rb' 模式)
          with open('wrangler.ci.toml', 'rb') as f:
              config = tomllib.load(f)

          # 2. 注入 BUILD_SHA
          build_sha = os.environ.get('GITHUB_SHA', 'unknown')
          if 'vars' not in config:
              config['vars'] = {}
          config['vars']['BUILD_SHA'] = build_sha

          # 3. 验证逻辑
          placement = config.get("placement") or {}
          region = (placement.get("region") or "").strip()
          if region != "aws:us-east-1":
              raise SystemExit('wrangler.ci.toml: missing [placement] region = "aws:us-east-1"')

          def normalize_dir(v: str) -> str:
              s = (v or "").strip().replace("\\", "/")
              while s.startswith("./"): s = s[2:]
              return s.rstrip("/")

          assets = config.get("assets") or {}
          directory = normalize_dir(assets.get("directory") or "")
          binding = (assets.get("binding") or "").strip()
          if directory != "app/static" or binding != "ASSETS":
              raise SystemExit(f'wrangler.ci.toml: assets 绑定错误。Got: dir={directory}, bind={binding}')

          # 4. 写回文件 (使用 tomli_w.dump 且必须使用 'wb' 模式)
          with open('wrangler.ci.toml', 'wb') as f:
              tomli_w.dump(config, f)
          
          print(f"OK: placement.region = aws:us-east-1; BUILD_SHA={build_sha}")
          PY
        env:
          GITHUB_SHA: ${{ github.sha }}
